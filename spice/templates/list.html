<!DOCTYPE html>
<html>
  <head>
    <title>All files</title>
    <link rel="stylesheet" href="{{ static_web_path }}/spice.css">
  </head>
  <body>
    {% if files|length %}
      <table class="box file-list" id="files" cellspacing="0">
        {% for file in files %}
        <tr class="hover">
          <td>
            <a href="/{{ file.get_key() }}">
              {{ file.name }}
            </a>
          </td>
          <td>{{ file.get_key() }}</td>
          <td>{{ file.view|default('0') }}</td>
          <td>{{ file.created.strftime('%Y-%m-%d') }}</td>
          <td class="hover-show"><a href="/remove/{{ file.id }}">&times;<a></td>
        </tr>
        {% endfor %}
      </table>
    {% else %}
    No files uploaded
    {% endif %}
    <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>
    <script id="uploadTemplate" type="template/text">
        <td><%= name %></td>
        <td><%= progress %>%</td>
        <td>&mdash;</td>
        <td><%= status %></td>
        <td></td>
    </script>
    <script id="rowTemplate" type="template/text">
        <td>
          <a href="/<%= key %>">
            <%= name %>
          </a>
        </td>
        <td><%= key %></td>
        <td>0</td>
        <td><%= created %></td>
        <td class="hover-show"><a href="/remove/<%= id %>">&times;<a></td>
    </script>
    <script>
      var FileModel = Backbone.Model.extend({
        save: function () {
          var self = this;
          //using XHR directly because jquery does not expose the upload
          //property - works in chrome and FF (IE shouldn't get this code)
          var xhr = new XMLHttpRequest();

          xhr.upload.addEventListener("progress", function (e) {
            if (e.lengthComputable) {
              var percentage = Math.round((e.loaded * 100) / e.total);
              self.set({
                'progress': percentage,
                'loaded': e.loaded,
                'total': e.total,
              })
            }
          }, false);

          xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
              if ((xhr.status >= 200 && xhr.status <= 200) || xhr.status === 304) {
                if (xhr.responseText !== "") {
                  var item = $.parseJSON(xhr.responseText);
                  console.log(item);
                  self.set(item);
                }
              }
            }
          };

          var data = new FormData();
          data.append('file', self.get('file'));
          console.log(self.get('file'));
          data.append('json', true);

          xhr.open("POST", "/upload");
          xhr.send(data);
        }
      });

      var FileView = Backbone.View.extend({
        tagName: 'tr',
        className: 'hover',
        uploadTemplate: _.template($('#uploadTemplate').html()),
        template: _.template($('#rowTemplate').html()),
        events: function () {
          this.listenTo(this.model, 'change:progress', this.render);
          this.listenTo(this.model, 'change:key', this.render);
        },
        render: function () {
          if (this.model.get('key')) {
            this.$el.html(this.template(this.model.toJSON()));
          }
          else {
            this.$el.html(this.uploadTemplate(this.model.toJSON()));
          }
        }
      });

      //file api code
      if (typeof FileReader === "function") {

        //add our dnd listeners
        $('body').bind({
          dragover: function (event) { event.preventDefault(); },
          dragleave: function (event) { event.preventDefault(); },
          drop: function (event) {
            event.preventDefault();

            var originalEvent = event.originalEvent;
            var files = (originalEvent.files || originalEvent.dataTransfer.files);
            for (var i = 0; i < files.length; i += 1) {
              //queue objects to be uploaded
              var file = files[i];
              var model = new FileModel({
                name: file.name,
                progress: 0,
                status: 'queued',
                file: file
              })

              var view = new FileView({model: model});
              $('#files').prepend(view.el);
              view.render();

              model.save();
            }
          }
        });
      }
    </script>
  </body>
</html>
